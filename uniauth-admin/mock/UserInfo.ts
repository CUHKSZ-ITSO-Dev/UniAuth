// @ts-ignore
import { Request, Response } from "express";


export default {
  "GET /userinfos": (req: Request, res: Response) => {
    const upn = req.query.upn as string;
    
    const allUsers = [
      {
        upn: "122020255@link.cuhk.edu.cn",
        email: "user255@cuhk.edu.cn",
        displayName: "User 255",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020255",
        name: "张三",
        tags: ["student", "cs"],
        department: "计算机科学",
        title: "学生",
        office: "教学楼A",
        officePhone: "12345678",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user255",
        mailNickname: "user255",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020256@link.cuhk.edu.cn",
        email: "user256@cuhk.edu.cn",
        displayName: "User 256",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020256",
        name: "李四",
        tags: ["student", "math"],
        department: "数学系",
        title: "学生",
        office: "教学楼B",
        officePhone: "23456789",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user256",
        mailNickname: "user256",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020250@link.cuhk.edu.cn",
        email: "user250@cuhk.edu.cn",
        displayName: "王五",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020250",
        name: "王五",
        tags: ["student", "physics"],
        department: "物理系",
        title: "学生",
        office: "教学楼C",
        officePhone: "34567890",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user250",
        mailNickname: "user250",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020251@link.cuhk.edu.cn",
        email: "user251@cuhk.edu.cn",
        displayName: "赵六",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020251",
        name: "赵六",
        tags: ["student", "chemistry"],
        department: "化学系",
        title: "学生",
        office: "教学楼D",
        officePhone: "45678901",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user251",
        mailNickname: "user251",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020252@link.cuhk.edu.cn",
        email: "user252@cuhk.edu.cn",
        displayName: "钱七",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020252",
        name: "钱七",
        tags: ["student", "biology"],
        department: "生物系",
        title: "学生",
        office: "教学楼E",
        officePhone: "56789012",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user252",
        mailNickname: "user252",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020253@link.cuhk.edu.cn",
        email: "user253@cuhk.edu.cn",
        displayName: "孙八",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020253",
        name: "孙八",
        tags: ["student", "engineering"],
        department: "工程系",
        title: "学生",
        office: "教学楼F",
        officePhone: "67890123",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user253",
        mailNickname: "user253",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020254@link.cuhk.edu.cn",
        email: "user254@cuhk.edu.cn",
        displayName: "周九",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020254",
        name: "周九",
        tags: ["student", "business"],
        department: "商学院",
        title: "学生",
        office: "教学楼G",
        officePhone: "78901234",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user254",
        mailNickname: "user254",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "12202025@link.cuhk.edu.cn",
        email: "user25@cuhk.edu.cn",
        displayName: "吴十",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "12202025",
        name: "吴十",
        tags: ["student", "literature"],
        department: "文学院",
        title: "学生",
        office: "教学楼H",
        officePhone: "89012345",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user25",
        mailNickname: "user25",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020257@link.cuhk.edu.cn",
        email: "user257@cuhk.edu.cn",
        displayName: "郑十一",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020257",
        name: "郑十一",
        tags: ["student", "medicine"],
        department: "医学院",
        title: "学生",
        office: "教学楼I",
        officePhone: "90123456",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user257",
        mailNickname: "user257",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020258@link.cuhk.edu.cn",
        email: "user258@cuhk.edu.cn",
        displayName: "王十二",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020258",
        name: "王十二",
        tags: ["student", "law"],
        department: "法学院",
        title: "学生",
        office: "教学楼J",
        officePhone: "01234567",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user258",
        mailNickname: "user258",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020259@link.cuhk.edu.cn",
        email: "user259@cuhk.edu.cn",
        displayName: "李十三",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020259",
        name: "李十三",
        tags: ["student", "art"],
        department: "艺术学院",
        title: "学生",
        office: "教学楼K",
        officePhone: "12345678",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user259",
        mailNickname: "user259",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      }
    ];
    
    const user = allUsers.find(u => u.upn === upn);
    
    if (user) {
      res.status(200).send(user);
    } else {
      res.status(404).send({ error: "User not found" });
    }
  },
  "POST /userinfos/filter": (req: Request, res: Response) => {
    const { page = 1, pageSize = 10, all = false } = req.body?.pagination || {};
    const { filter } = req.body || {};
    
    const allUsers = [
      {
        upn: "122020255@link.cuhk.edu.cn",
        email: "user255@cuhk.edu.cn",
        displayName: "User 255",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020255",
        name: "张三",
        tags: ["student", "cs"],
        department: "计算机科学",
        title: "学生",
        office: "教学楼A",
        officePhone: "12345678",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user255",
        mailNickname: "user255",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020256@link.cuhk.edu.cn",
        email: "user256@cuhk.edu.cn",
        displayName: "User 256",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020256",
        name: "李四",
        tags: ["student", "math"],
        department: "数学系",
        title: "学生",
        office: "教学楼B",
        officePhone: "23456789",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user256",
        mailNickname: "user256",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020257@link.cuhk.edu.cn",
        email: "T]4",
        displayName: "ez]UL",
        schoolStatus: ")omOlW",
        identityType: "uCe#[",
        employeeId: "vCmnQf",
        name: "tuou[",
        tags: ["M1q4", "78A", "!ouB", "ykYDVH"],
        department: "0eau3",
        title: "5Tg00",
        office: "Sxg",
        officePhone: "(g[6",
        employeeType: "gO1tk",
        fundingTypeOrAdmissionYear: "(AB6WB",
        studentCategoryPrimary: "QRTR5",
        studentCategoryDetail: "1Idz",
        studentNationalityType: "ccQPw",
        residentialCollege: "*TrrJ",
        staffRole: "m@V2%W",
        samAccountName: "9mI",
        mailNickname: "(z2x2",
        createdAt: "7ymuBS",
        updatedAt: ")]*5",
      },
      {
        upn: "122020258@link.cuhk.edu.cn",
        email: "CGgV",
        displayName: "DejE",
        schoolStatus: "@VCq3H4",
        identityType: "l%!Sz!",
        employeeId: "QKZozov",
        name: "5ZAx*3",
        tags: ["KA]*$Y", "cCdG[V", "QSxDr", "lI*i6K"],
        department: "ORJz",
        title: "kDPo9E",
        office: ")ya$W%",
        officePhone: "EsuH",
        employeeType: "^nb",
        fundingTypeOrAdmissionYear: "JxW(",
        studentCategoryPrimary: "z98c",
        studentCategoryDetail: "@30[",
        studentNationalityType: "lE!ZW",
        residentialCollege: "ZRyIcR",
        staffRole: "wM21)O[",
        samAccountName: "BYWLY0",
        mailNickname: "f*zE&z",
        createdAt: "Y2u@E",
        updatedAt: "I0k&(",
      },
      {
        upn: "122020259@link.cuhk.edu.cn",
        email: "r]*kJQ",
        displayName: "z[MBBu",
        schoolStatus: "iZWLe",
        identityType: "8uNm#a",
        employeeId: "4s4ROEY",
        name: "8UTsw",
        tags: ["Sx&^", "XxJ#D", "TwBN", "&o6N1U"],
        department: "!7std]",
        title: "A$!OKW",
        office: "FpraUw",
        officePhone: "1CrLLm",
        employeeType: "mcTe",
        fundingTypeOrAdmissionYear: "iR3dx",
        studentCategoryPrimary: "kMu6",
        studentCategoryDetail: "U2(r",
        studentNationalityType: "M5Tt9",
        residentialCollege: "HgrLiP",
        staffRole: "u^j",
        samAccountName: "!J2c",
        mailNickname: "h4p",
        createdAt: "$SRsG",
        updatedAt: "Ux(Hr",
      },
      {
        upn: "122020250@link.cuhk.edu.cn",
        email: "user250@cuhk.edu.cn",
        displayName: "王五",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020250",
        name: "王五",
        tags: ["student", "physics"],
        department: "物理系",
        title: "学生",
        office: "教学楼C",
        officePhone: "34567890",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user250",
        mailNickname: "user250",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020251@link.cuhk.edu.cn",
        email: "user251@cuhk.edu.cn",
        displayName: "赵六",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020251",
        name: "赵六",
        tags: ["student", "chemistry"],
        department: "化学系",
        title: "学生",
        office: "教学楼D",
        officePhone: "45678901",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user251",
        mailNickname: "user251",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020252@link.cuhk.edu.cn",
        email: "user252@cuhk.edu.cn",
        displayName: "钱七",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020252",
        name: "钱七",
        tags: ["student", "biology"],
        department: "生物系",
        title: "学生",
        office: "教学楼E",
        officePhone: "56789012",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user252",
        mailNickname: "user252",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020253@link.cuhk.edu.cn",
        email: "user253@cuhk.edu.cn",
        displayName: "孙八",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020253",
        name: "孙八",
        tags: ["student", "engineering"],
        department: "工程系",
        title: "学生",
        office: "教学楼F",
        officePhone: "67890123",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user253",
        mailNickname: "user253",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "122020254@link.cuhk.edu.cn",
        email: "user254@cuhk.edu.cn",
        displayName: "周九",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "122020254",
        name: "周九",
        tags: ["student", "business"],
        department: "商学院",
        title: "学生",
        office: "教学楼G",
        officePhone: "78901234",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "SHAW",
        staffRole: "Student",
        samAccountName: "user254",
        mailNickname: "user254",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      },
      {
        upn: "12202025@link.cuhk.edu.cn",
        email: "user25@cuhk.edu.cn",
        displayName: "吴十",
        schoolStatus: "In-School",
        identityType: "Student",
        employeeId: "12202025",
        name: "吴十",
        tags: ["student", "literature"],
        department: "文学院",
        title: "学生",
        office: "教学楼H",
        officePhone: "89012345",
        employeeType: "Student",
        fundingTypeOrAdmissionYear: "2020",
        studentCategoryPrimary: "Undergraduate",
        studentCategoryDetail: "Undergraduate",
        studentNationalityType: "Local",
        residentialCollege: "MUSE",
        staffRole: "Student",
        samAccountName: "user25",
        mailNickname: "user25",
        createdAt: "2020-09-01",
        updatedAt: "2024-01-01",
      }
    ];

    // 定义过滤条件类型
    interface FilterCondition {
      field: string;
      op: 'like' | 'eq';
      value: string;
    }
    
    interface FilterGroup {
      logic: 'or' | 'and';
      conditions: FilterCondition[];
    }
    
    // 过滤逻辑
    let filteredUsers = [...allUsers];
    
    if (filter && filter.conditions && filter.conditions.length > 0) {
      const { conditions, logic = 'or' } = filter as FilterGroup;
      
      // 处理中文编码问题
      filteredUsers = filteredUsers.filter(user => {
        if (logic === 'or') {
          return conditions.some((condition: FilterCondition) => {
            const { field, op, value } = condition;
            const userValue = user[field as keyof typeof user];
            
            if (userValue === undefined || userValue === null) return false;
            
            // 直接比较，避免编码问题
            const searchValue = String(value).replace(/%/g, '');
            const userString = String(userValue);
            
            if (op === 'like') {
              return userString.indexOf(searchValue) !== -1;
            } else if (op === 'eq') {
              return userString === searchValue;
            }
            return false;
          });
        } else {
          return conditions.every((condition: FilterCondition) => {
            const { field, op, value } = condition;
            const userValue = user[field as keyof typeof user];
            
            if (userValue === undefined || userValue === null) return false;
            
            const searchValue = String(value).replace(/%/g, '');
            const userString = String(userValue);
            
            if (op === 'like') {
              return userString.indexOf(searchValue) !== -1;
            } else if (op === 'eq') {
              return userString === searchValue;
            }
            return false;
          });
        }
      });
    }

    // 计算分页
    const total = filteredUsers.length;
    const startIndex = all ? 0 : (page - 1) * pageSize;
    const endIndex = all ? total : Math.min(startIndex + pageSize, total);
    const pagedUsers = filteredUsers.slice(startIndex, endIndex);

    const userUpns = pagedUsers.map(user => user.upn);

    res.status(200).send({
      userUpns,
      userInfos: pagedUsers,
      total,
      page,
      pageSize,
      totalPages: Math.ceil(total / pageSize),
      isAll: all,
    });
  },
};
